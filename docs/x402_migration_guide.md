# x402 Enhanced Migration Guide\n\n本格的なBase Mainnet USDC対応への移行ガイド\n\n## 概要\n\n現在のxCockpitプロジェクトを、本格的なBase Mainnet USDCを使用する即時認可システムに移行するためのステップバイステップガイドです。\n\n## 🎯 移行の目標\n\n- **セキュリティ強化**: オンチェーン検証とHMAC署名による改ざん防止\n- **リプレイ攻撃対策**: nonce/order_id管理による一回限りの使用保証\n- **本格運用対応**: Base Mainnet USDCでの実際の価値取引\n- **UX向上**: 確認数制御による即時性と安全性の両立\n\n## 📋 移行前チェックリスト\n\n### 必要な準備\n\n- [ ] Base Mainnet RPCエンドポイントの準備（Alchemy/Infura等）\n- [ ] 本番用ウォレットアドレスの準備\n- [ ] HMAC秘密鍵の生成\n- [ ] 環境変数の設定\n- [ ] テスト用Base Sepolia USDCでの動作確認\n\n### 依存関係のインストール\n\n```bash\nnpm install ethers@^6.0.0\n```\n\n## 🚀 段階的移行手順\n\n### Phase 1: 基盤実装（完了済み）\n\n#### 1.1 BlockchainVerifier実装\n\n```typescript\n// server/services/blockchain-verifier.ts が実装済み\n// 機能：\n// - オンチェーンUSDC転送の検証\n// - 確認数の監視\n// - Base Mainnet/Sepolia対応\n```\n\n#### 1.2 OrderManager実装\n\n```typescript\n// server/services/order-manager.ts が実装済み\n// 機能：\n// - nonce/order_id生成と管理\n// - リプレイ攻撃防止\n// - 期限切れオーダーの自動クリーンアップ\n```\n\n### Phase 2: セキュリティ強化（完了済み）\n\n#### 2.1 HMAC署名検証実装\n\n```typescript\n// server/services/signature-verifier.ts が実装済み\n// 機能：\n// - 支払い要件のHMAC-SHA256署名\n// - 改ざん検知\n// - 署名ヘッダーの解析\n```\n\n#### 2.2 X402サービス更新\n\n```typescript\n// server/services/x402.ts が更新済み\n// 新機能：\n// - 強化された支払い検証\n// - 署名付き402レスポンス\n// - 段階的移行対応（環境変数による制御）\n```\n\n### Phase 3: 環境設定（完了済み）\n\n#### 3.1 環境変数設定\n\n`.env`ファイルを更新：\n\n```bash\n# Network Selection\nNETWORK=sepolia  # または mainnet\nENHANCED_X402=false  # テスト時は false\n\n# Base Mainnet Configuration\nBASE_MAINNET_RPC=https://mainnet.base.org\nBASE_MAINNET_USDC=0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913\n\n# Security\nX402_HMAC_SECRET=your_secret_key_here_change_in_production\nPAYMENT_RECIPIENT=0x1c7d4b196cb0c7b01d743fbc6116a902379c7238\n\n# Device Pricing (CLAUDE.mdの要求に従い更新済み)\nDEVICE_ESP32_001_PRICE=0.01   # Gacha #001のfeeを$0.01 USDCに設定\nDEVICE_ESP32_002_PRICE=0.005  # Gacha #002のfeeを$0.005USDCに設定\n```\n\n#### 3.2 フロントエンドUI実装\n\n確認数制御コンポーネントが実装済み：\n\n- `src/components/confirmation-settings.tsx`\n- `src/components/enhanced-payment-status.tsx`\n\n### Phase 4: テスト（完了済み）\n\n#### 4.1 統合テスト\n\n```bash\n# テスト実行\nnpm test server/tests/x402-enhanced.test.ts\n```\n\nテストカバレッジ：\n- OrderManager機能テスト\n- SignatureVerifier機能テスト\n- BlockchainVerifier機能テスト\n- セキュリティテスト（リプレイ攻撃防止等）\n\n## 🔄 本格運用への移行手順\n\n### Step 1: Sepoliaでの最終テスト\n\n```bash\n# 環境設定\nexport NETWORK=sepolia\nexport ENHANCED_X402=true\nexport X402_HMAC_SECRET=\"your-test-secret\"\n\n# サーバー起動\nnpm run dev\n\n# テスト実行\ncurl -X POST http://localhost:5000/api/device/ESP32_001/dispense \\\n  -H \"Authorization: Bearer test-token\"\n```\n\n期待される402レスポンス：\n\n```json\n{\n  \"status\": 402,\n  \"headers\": {\n    \"X-Payment-Requirements\": \"scheme=\\\"x402-exact\\\", chain=\\\"eip155:84532\\\", ...\",\n    \"X-Payment-Signature\": \"v1=a1b2c3d4...\"\n  },\n  \"body\": {\n    \"orderId\": \"ord_...\",\n    \"nonce\": \"nx_...\",\n    \"expiresAt\": \"2025-09-01T...\"\n  }\n}\n```\n\n### Step 2: Mainnetへの切り替え\n\n```bash\n# 本番環境変数設定\nexport NETWORK=mainnet\nexport ENHANCED_X402=true\nexport BASE_MAINNET_RPC=\"https://mainnet.base.org\"\nexport X402_HMAC_SECRET=\"your-production-secret-32-chars\"\nexport PAYMENT_RECIPIENT=\"0x...\"  # 本番用ウォレット\n```\n\n### Step 3: 動作確認\n\n1. **402レスポンス確認**\n   ```bash\n   # Base Mainnetアドレスが使用されることを確認\n   curl -X POST http://localhost:5000/api/device/ESP32_001/dispense\n   # レスポンスに eip155:8453 (Base Mainnet) が含まれることを確認\n   ```\n\n2. **実際のUSDC支払いテスト**\n   ```bash\n   # 小額（$0.01）での動作確認\n   # MetaMaskでBase Mainnet USDC転送後、支払い検証をテスト\n   ```\n\n3. **確認数制御テスト**\n   ```bash\n   # 即時確認（0 confirmations）\n   # 安全確認（2-3 confirmations）\n   # の両方をテスト\n   ```\n\n## 🛠️ トラブルシューティング\n\n### よくある問題と解決方法\n\n#### 1. トランザクション検証失敗\n\n**症状**: `verifyPayment`が常にfalseを返す\n\n**原因と解決**:\n```bash\n# RPC接続確認\ncurl -X POST https://mainnet.base.org \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"jsonrpc\":\"2.0\",\"method\":\"eth_blockNumber\",\"params\":[],\"id\":1}'\n\n# USDCコントラクトアドレス確認\n# Mainnet: 0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913\n# Sepolia: 0x036CbD53842c5426634e7929541eC2318f3dCF7e\n```\n\n#### 2. 署名検証エラー\n\n**症状**: \"Invalid signature\" エラー\n\n**解決**:\n```typescript\n// HMAC秘密鍵が正しく設定されているか確認\nconsole.log('HMAC Secret:', process.env.X402_HMAC_SECRET?.substring(0, 8) + '...');\n\n// クライアントとサーバーで同じ秘密鍵を使用していることを確認\n```\n\n#### 3. Order期限切れ\n\n**症状**: \"Order expired\" エラーが頻発\n\n**解決**:\n```typescript\n// TTLを延長\nconst response = X402Service.create402Response('ESP32_001', 'dispense', 10); // 10分\n\n// またはフロントエンドでの処理速度向上\n```\n\n#### 4. 確認数不足\n\n**症状**: \"Insufficient confirmations\" エラー\n\n**解決**:\n```typescript\n// より長い待機時間設定\nawait X402Service.waitForConfirmations(txHash, 3, 120000); // 2分待機\n\n// または確認数を下げる（開発時のみ）\n// minConfirmations: 0  // 即時確認\n```\n\n## 🔒 セキュリティ考慮事項\n\n### 本番運用での注意点\n\n1. **HMAC秘密鍵管理**\n   ```bash\n   # 32文字以上のランダムな秘密鍵を生成\n   openssl rand -hex 32\n   \n   # 環境変数で管理し、ソースコードに含めない\n   export X402_HMAC_SECRET=\"生成された秘密鍵\"\n   ```\n\n2. **ウォレットセキュリティ**\n   ```bash\n   # 受信専用ウォレットの使用を推奨\n   # 定期的な資金移動による残高管理\n   # マルチシグウォレットの検討\n   ```\n\n3. **RPC エンドポイント**\n   ```bash\n   # 信頼できるプロバイダーの使用\n   # レート制限とフェイルオーバーの設定\n   # API キーの適切な管理\n   ```\n\n4. **ログ管理**\n   ```typescript\n   // 秘密情報のログ出力を避ける\n   console.log('Payment verified:', { orderId, confirmations }); // OK\n   console.log('HMAC secret:', process.env.X402_HMAC_SECRET); // NG\n   ```\n\n## 📊 監視とメトリクス\n\n### 推奨する監視項目\n\n1. **支払い成功率**\n   ```typescript\n   // メトリクス収集\n   const successRate = (successfulPayments / totalPayments) * 100;\n   ```\n\n2. **平均確認時間**\n   ```typescript\n   // 確認時間の追跡\n   const confirmationTime = endTime - startTime;\n   ```\n\n3. **エラー率**\n   ```typescript\n   // エラータイプ別の集計\n   const errorTypes = {\n     'blockchain_verification_failed': 0,\n     'signature_verification_failed': 0,\n     'order_expired': 0\n   };\n   ```\n\n4. **RPC応答時間**\n   ```typescript\n   // RPCクォータとレスポンス時間の監視\n   ```\n\n## 🔄 ロールバック手順\n\n問題が発生した場合の緊急ロールバック：\n\n```bash\n# 基本検証モードに戻す\nexport ENHANCED_X402=false\n\n# Sepoliaに戻す（必要に応じて）\nexport NETWORK=sepolia\n\n# サーバー再起動\nnpm run dev\n```\n\n## 📈 パフォーマンス最適化\n\n### 推奨設定\n\n```typescript\n// 確認数の動的調整\nconst getOptimalConfirmations = (amount: number): number => {\n  if (amount < 1) return 0;    // $1未満は即時\n  if (amount < 10) return 2;   // $10未満は2確認\n  return 3;                    // $10以上は3確認\n};\n\n// RPC接続プールの利用\nconst provider = new ethers.JsonRpcProvider(rpcUrl, {\n  staticNetwork: true,\n  batchMaxCount: 10\n});\n```\n\n## 🎉 移行完了\n\n全ての手順が完了すると：\n\n- ✅ 本格的なBase Mainnet USDCでの即時支払い\n- ✅ 暗号学的に安全な署名検証\n- ✅ リプレイ攻撃耐性\n- ✅ 柔軟な確認数制御\n- ✅ 包括的なエラーハンドリング\n- ✅ 本番運用レベルのセキュリティ\n\nが実現されます。\n\n移行に関する質問や問題がございましたら、開発チームまでお気軽にお声がけください。"