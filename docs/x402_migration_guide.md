# x402 Enhanced Migration Guide\n\næœ¬æ ¼çš„ãªBase Mainnet USDCå¯¾å¿œã¸ã®ç§»è¡Œã‚¬ã‚¤ãƒ‰\n\n## æ¦‚è¦\n\nç¾åœ¨ã®xCockpitãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ã€æœ¬æ ¼çš„ãªBase Mainnet USDCã‚’ä½¿ç”¨ã™ã‚‹å³æ™‚èªå¯ã‚·ã‚¹ãƒ†ãƒ ã«ç§»è¡Œã™ã‚‹ãŸã‚ã®ã‚¹ãƒ†ãƒƒãƒ—ãƒã‚¤ã‚¹ãƒ†ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰ã§ã™ã€‚\n\n## ðŸŽ¯ ç§»è¡Œã®ç›®æ¨™\n\n- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–**: ã‚ªãƒ³ãƒã‚§ãƒ¼ãƒ³æ¤œè¨¼ã¨HMACç½²åã«ã‚ˆã‚‹æ”¹ã–ã‚“é˜²æ­¢\n- **ãƒªãƒ—ãƒ¬ã‚¤æ”»æ’ƒå¯¾ç­–**: nonce/order_idç®¡ç†ã«ã‚ˆã‚‹ä¸€å›žé™ã‚Šã®ä½¿ç”¨ä¿è¨¼\n- **æœ¬æ ¼é‹ç”¨å¯¾å¿œ**: Base Mainnet USDCã§ã®å®Ÿéš›ã®ä¾¡å€¤å–å¼•\n- **UXå‘ä¸Š**: ç¢ºèªæ•°åˆ¶å¾¡ã«ã‚ˆã‚‹å³æ™‚æ€§ã¨å®‰å…¨æ€§ã®ä¸¡ç«‹\n\n## ðŸ“‹ ç§»è¡Œå‰ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ\n\n### å¿…è¦ãªæº–å‚™\n\n- [ ] Base Mainnet RPCã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®æº–å‚™ï¼ˆAlchemy/Infuraç­‰ï¼‰\n- [ ] æœ¬ç•ªç”¨ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ã®æº–å‚™\n- [ ] HMACç§˜å¯†éµã®ç”Ÿæˆ\n- [ ] ç’°å¢ƒå¤‰æ•°ã®è¨­å®š\n- [ ] ãƒ†ã‚¹ãƒˆç”¨Base Sepolia USDCã§ã®å‹•ä½œç¢ºèª\n\n### ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«\n\n```bash\nnpm install ethers@^6.0.0\n```\n\n## ðŸš€ æ®µéšŽçš„ç§»è¡Œæ‰‹é †\n\n### Phase 1: åŸºç›¤å®Ÿè£…ï¼ˆå®Œäº†æ¸ˆã¿ï¼‰\n\n#### 1.1 BlockchainVerifierå®Ÿè£…\n\n```typescript\n// server/services/blockchain-verifier.ts ãŒå®Ÿè£…æ¸ˆã¿\n// æ©Ÿèƒ½ï¼š\n// - ã‚ªãƒ³ãƒã‚§ãƒ¼ãƒ³USDCè»¢é€ã®æ¤œè¨¼\n// - ç¢ºèªæ•°ã®ç›£è¦–\n// - Base Mainnet/Sepoliaå¯¾å¿œ\n```\n\n#### 1.2 OrderManagerå®Ÿè£…\n\n```typescript\n// server/services/order-manager.ts ãŒå®Ÿè£…æ¸ˆã¿\n// æ©Ÿèƒ½ï¼š\n// - nonce/order_idç”Ÿæˆã¨ç®¡ç†\n// - ãƒªãƒ—ãƒ¬ã‚¤æ”»æ’ƒé˜²æ­¢\n// - æœŸé™åˆ‡ã‚Œã‚ªãƒ¼ãƒ€ãƒ¼ã®è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\n```\n\n### Phase 2: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ï¼ˆå®Œäº†æ¸ˆã¿ï¼‰\n\n#### 2.1 HMACç½²åæ¤œè¨¼å®Ÿè£…\n\n```typescript\n// server/services/signature-verifier.ts ãŒå®Ÿè£…æ¸ˆã¿\n// æ©Ÿèƒ½ï¼š\n// - æ”¯æ‰•ã„è¦ä»¶ã®HMAC-SHA256ç½²å\n// - æ”¹ã–ã‚“æ¤œçŸ¥\n// - ç½²åãƒ˜ãƒƒãƒ€ãƒ¼ã®è§£æž\n```\n\n#### 2.2 X402ã‚µãƒ¼ãƒ“ã‚¹æ›´æ–°\n\n```typescript\n// server/services/x402.ts ãŒæ›´æ–°æ¸ˆã¿\n// æ–°æ©Ÿèƒ½ï¼š\n// - å¼·åŒ–ã•ã‚ŒãŸæ”¯æ‰•ã„æ¤œè¨¼\n// - ç½²åä»˜ã402ãƒ¬ã‚¹ãƒãƒ³ã‚¹\n// - æ®µéšŽçš„ç§»è¡Œå¯¾å¿œï¼ˆç’°å¢ƒå¤‰æ•°ã«ã‚ˆã‚‹åˆ¶å¾¡ï¼‰\n```\n\n### Phase 3: ç’°å¢ƒè¨­å®šï¼ˆå®Œäº†æ¸ˆã¿ï¼‰\n\n#### 3.1 ç’°å¢ƒå¤‰æ•°è¨­å®š\n\n`.env`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°ï¼š\n\n```bash\n# Network Selection\nNETWORK=sepolia  # ã¾ãŸã¯ mainnet\nENHANCED_X402=false  # ãƒ†ã‚¹ãƒˆæ™‚ã¯ false\n\n# Base Mainnet Configuration\nBASE_MAINNET_RPC=https://mainnet.base.org\nBASE_MAINNET_USDC=0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913\n\n# Security\nX402_HMAC_SECRET=your_secret_key_here_change_in_production\nPAYMENT_RECIPIENT=0x1c7d4b196cb0c7b01d743fbc6116a902379c7238\n\n# Device Pricing (CLAUDE.mdã®è¦æ±‚ã«å¾“ã„æ›´æ–°æ¸ˆã¿)\nDEVICE_ESP32_001_PRICE=0.01   # Gacha #001ã®feeã‚’$0.01 USDCã«è¨­å®š\nDEVICE_ESP32_002_PRICE=0.005  # Gacha #002ã®feeã‚’$0.005USDCã«è¨­å®š\n```\n\n#### 3.2 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰UIå®Ÿè£…\n\nç¢ºèªæ•°åˆ¶å¾¡ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒå®Ÿè£…æ¸ˆã¿ï¼š\n\n- `src/components/confirmation-settings.tsx`\n- `src/components/enhanced-payment-status.tsx`\n\n### Phase 4: ãƒ†ã‚¹ãƒˆï¼ˆå®Œäº†æ¸ˆã¿ï¼‰\n\n#### 4.1 çµ±åˆãƒ†ã‚¹ãƒˆ\n\n```bash\n# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ\nnpm test server/tests/x402-enhanced.test.ts\n```\n\nãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ï¼š\n- OrderManageræ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ\n- SignatureVerifieræ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ\n- BlockchainVerifieræ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ\n- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆï¼ˆãƒªãƒ—ãƒ¬ã‚¤æ”»æ’ƒé˜²æ­¢ç­‰ï¼‰\n\n## ðŸ”„ æœ¬æ ¼é‹ç”¨ã¸ã®ç§»è¡Œæ‰‹é †\n\n### Step 1: Sepoliaã§ã®æœ€çµ‚ãƒ†ã‚¹ãƒˆ\n\n```bash\n# ç’°å¢ƒè¨­å®š\nexport NETWORK=sepolia\nexport ENHANCED_X402=true\nexport X402_HMAC_SECRET=\"your-test-secret\"\n\n# ã‚µãƒ¼ãƒãƒ¼èµ·å‹•\nnpm run dev\n\n# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ\ncurl -X POST http://localhost:5000/api/device/ESP32_001/dispense \\\n  -H \"Authorization: Bearer test-token\"\n```\n\næœŸå¾…ã•ã‚Œã‚‹402ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼š\n\n```json\n{\n  \"status\": 402,\n  \"headers\": {\n    \"X-Payment-Requirements\": \"scheme=\\\"x402-exact\\\", chain=\\\"eip155:84532\\\", ...\",\n    \"X-Payment-Signature\": \"v1=a1b2c3d4...\"\n  },\n  \"body\": {\n    \"orderId\": \"ord_...\",\n    \"nonce\": \"nx_...\",\n    \"expiresAt\": \"2025-09-01T...\"\n  }\n}\n```\n\n### Step 2: Mainnetã¸ã®åˆ‡ã‚Šæ›¿ãˆ\n\n```bash\n# æœ¬ç•ªç’°å¢ƒå¤‰æ•°è¨­å®š\nexport NETWORK=mainnet\nexport ENHANCED_X402=true\nexport BASE_MAINNET_RPC=\"https://mainnet.base.org\"\nexport X402_HMAC_SECRET=\"your-production-secret-32-chars\"\nexport PAYMENT_RECIPIENT=\"0x...\"  # æœ¬ç•ªç”¨ã‚¦ã‚©ãƒ¬ãƒƒãƒˆ\n```\n\n### Step 3: å‹•ä½œç¢ºèª\n\n1. **402ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç¢ºèª**\n   ```bash\n   # Base Mainnetã‚¢ãƒ‰ãƒ¬ã‚¹ãŒä½¿ç”¨ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª\n   curl -X POST http://localhost:5000/api/device/ESP32_001/dispense\n   # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã« eip155:8453 (Base Mainnet) ãŒå«ã¾ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª\n   ```\n\n2. **å®Ÿéš›ã®USDCæ”¯æ‰•ã„ãƒ†ã‚¹ãƒˆ**\n   ```bash\n   # å°é¡ï¼ˆ$0.01ï¼‰ã§ã®å‹•ä½œç¢ºèª\n   # MetaMaskã§Base Mainnet USDCè»¢é€å¾Œã€æ”¯æ‰•ã„æ¤œè¨¼ã‚’ãƒ†ã‚¹ãƒˆ\n   ```\n\n3. **ç¢ºèªæ•°åˆ¶å¾¡ãƒ†ã‚¹ãƒˆ**\n   ```bash\n   # å³æ™‚ç¢ºèªï¼ˆ0 confirmationsï¼‰\n   # å®‰å…¨ç¢ºèªï¼ˆ2-3 confirmationsï¼‰\n   # ã®ä¸¡æ–¹ã‚’ãƒ†ã‚¹ãƒˆ\n   ```\n\n## ðŸ› ï¸ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°\n\n### ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºæ–¹æ³•\n\n#### 1. ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³æ¤œè¨¼å¤±æ•—\n\n**ç—‡çŠ¶**: `verifyPayment`ãŒå¸¸ã«falseã‚’è¿”ã™\n\n**åŽŸå› ã¨è§£æ±º**:\n```bash\n# RPCæŽ¥ç¶šç¢ºèª\ncurl -X POST https://mainnet.base.org \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"jsonrpc\":\"2.0\",\"method\":\"eth_blockNumber\",\"params\":[],\"id\":1}'\n\n# USDCã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ç¢ºèª\n# Mainnet: 0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913\n# Sepolia: 0x036CbD53842c5426634e7929541eC2318f3dCF7e\n```\n\n#### 2. ç½²åæ¤œè¨¼ã‚¨ãƒ©ãƒ¼\n\n**ç—‡çŠ¶**: \"Invalid signature\" ã‚¨ãƒ©ãƒ¼\n\n**è§£æ±º**:\n```typescript\n// HMACç§˜å¯†éµãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª\nconsole.log('HMAC Secret:', process.env.X402_HMAC_SECRET?.substring(0, 8) + '...');\n\n// ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã‚µãƒ¼ãƒãƒ¼ã§åŒã˜ç§˜å¯†éµã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª\n```\n\n#### 3. OrderæœŸé™åˆ‡ã‚Œ\n\n**ç—‡çŠ¶**: \"Order expired\" ã‚¨ãƒ©ãƒ¼ãŒé »ç™º\n\n**è§£æ±º**:\n```typescript\n// TTLã‚’å»¶é•·\nconst response = X402Service.create402Response('ESP32_001', 'dispense', 10); // 10åˆ†\n\n// ã¾ãŸã¯ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ã®å‡¦ç†é€Ÿåº¦å‘ä¸Š\n```\n\n#### 4. ç¢ºèªæ•°ä¸è¶³\n\n**ç—‡çŠ¶**: \"Insufficient confirmations\" ã‚¨ãƒ©ãƒ¼\n\n**è§£æ±º**:\n```typescript\n// ã‚ˆã‚Šé•·ã„å¾…æ©Ÿæ™‚é–“è¨­å®š\nawait X402Service.waitForConfirmations(txHash, 3, 120000); // 2åˆ†å¾…æ©Ÿ\n\n// ã¾ãŸã¯ç¢ºèªæ•°ã‚’ä¸‹ã’ã‚‹ï¼ˆé–‹ç™ºæ™‚ã®ã¿ï¼‰\n// minConfirmations: 0  // å³æ™‚ç¢ºèª\n```\n\n## ðŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …\n\n### æœ¬ç•ªé‹ç”¨ã§ã®æ³¨æ„ç‚¹\n\n1. **HMACç§˜å¯†éµç®¡ç†**\n   ```bash\n   # 32æ–‡å­—ä»¥ä¸Šã®ãƒ©ãƒ³ãƒ€ãƒ ãªç§˜å¯†éµã‚’ç”Ÿæˆ\n   openssl rand -hex 32\n   \n   # ç’°å¢ƒå¤‰æ•°ã§ç®¡ç†ã—ã€ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã«å«ã‚ãªã„\n   export X402_HMAC_SECRET=\"ç”Ÿæˆã•ã‚ŒãŸç§˜å¯†éµ\"\n   ```\n\n2. **ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**\n   ```bash\n   # å—ä¿¡å°‚ç”¨ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã®ä½¿ç”¨ã‚’æŽ¨å¥¨\n   # å®šæœŸçš„ãªè³‡é‡‘ç§»å‹•ã«ã‚ˆã‚‹æ®‹é«˜ç®¡ç†\n   # ãƒžãƒ«ãƒã‚·ã‚°ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã®æ¤œè¨Ž\n   ```\n\n3. **RPC ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**\n   ```bash\n   # ä¿¡é ¼ã§ãã‚‹ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®ä½¿ç”¨\n   # ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã¨ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼ã®è¨­å®š\n   # API ã‚­ãƒ¼ã®é©åˆ‡ãªç®¡ç†\n   ```\n\n4. **ãƒ­ã‚°ç®¡ç†**\n   ```typescript\n   // ç§˜å¯†æƒ…å ±ã®ãƒ­ã‚°å‡ºåŠ›ã‚’é¿ã‘ã‚‹\n   console.log('Payment verified:', { orderId, confirmations }); // OK\n   console.log('HMAC secret:', process.env.X402_HMAC_SECRET); // NG\n   ```\n\n## ðŸ“Š ç›£è¦–ã¨ãƒ¡ãƒˆãƒªã‚¯ã‚¹\n\n### æŽ¨å¥¨ã™ã‚‹ç›£è¦–é …ç›®\n\n1. **æ”¯æ‰•ã„æˆåŠŸçŽ‡**\n   ```typescript\n   // ãƒ¡ãƒˆãƒªã‚¯ã‚¹åŽé›†\n   const successRate = (successfulPayments / totalPayments) * 100;\n   ```\n\n2. **å¹³å‡ç¢ºèªæ™‚é–“**\n   ```typescript\n   // ç¢ºèªæ™‚é–“ã®è¿½è·¡\n   const confirmationTime = endTime - startTime;\n   ```\n\n3. **ã‚¨ãƒ©ãƒ¼çŽ‡**\n   ```typescript\n   // ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—åˆ¥ã®é›†è¨ˆ\n   const errorTypes = {\n     'blockchain_verification_failed': 0,\n     'signature_verification_failed': 0,\n     'order_expired': 0\n   };\n   ```\n\n4. **RPCå¿œç­”æ™‚é–“**\n   ```typescript\n   // RPCã‚¯ã‚©ãƒ¼ã‚¿ã¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ã®ç›£è¦–\n   ```\n\n## ðŸ”„ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †\n\nå•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆã®ç·Šæ€¥ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼š\n\n```bash\n# åŸºæœ¬æ¤œè¨¼ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã™\nexport ENHANCED_X402=false\n\n# Sepoliaã«æˆ»ã™ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰\nexport NETWORK=sepolia\n\n# ã‚µãƒ¼ãƒãƒ¼å†èµ·å‹•\nnpm run dev\n```\n\n## ðŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹æœ€é©åŒ–\n\n### æŽ¨å¥¨è¨­å®š\n\n```typescript\n// ç¢ºèªæ•°ã®å‹•çš„èª¿æ•´\nconst getOptimalConfirmations = (amount: number): number => {\n  if (amount < 1) return 0;    // $1æœªæº€ã¯å³æ™‚\n  if (amount < 10) return 2;   // $10æœªæº€ã¯2ç¢ºèª\n  return 3;                    // $10ä»¥ä¸Šã¯3ç¢ºèª\n};\n\n// RPCæŽ¥ç¶šãƒ—ãƒ¼ãƒ«ã®åˆ©ç”¨\nconst provider = new ethers.JsonRpcProvider(rpcUrl, {\n  staticNetwork: true,\n  batchMaxCount: 10\n});\n```\n\n## ðŸŽ‰ ç§»è¡Œå®Œäº†\n\nå…¨ã¦ã®æ‰‹é †ãŒå®Œäº†ã™ã‚‹ã¨ï¼š\n\n- âœ… æœ¬æ ¼çš„ãªBase Mainnet USDCã§ã®å³æ™‚æ”¯æ‰•ã„\n- âœ… æš—å·å­¦çš„ã«å®‰å…¨ãªç½²åæ¤œè¨¼\n- âœ… ãƒªãƒ—ãƒ¬ã‚¤æ”»æ’ƒè€æ€§\n- âœ… æŸ”è»Ÿãªç¢ºèªæ•°åˆ¶å¾¡\n- âœ… åŒ…æ‹¬çš„ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°\n- âœ… æœ¬ç•ªé‹ç”¨ãƒ¬ãƒ™ãƒ«ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£\n\nãŒå®Ÿç¾ã•ã‚Œã¾ã™ã€‚\n\nç§»è¡Œã«é–¢ã™ã‚‹è³ªå•ã‚„å•é¡ŒãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€é–‹ç™ºãƒãƒ¼ãƒ ã¾ã§ãŠæ°—è»½ã«ãŠå£°ãŒã‘ãã ã•ã„ã€‚"