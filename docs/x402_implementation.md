# x402 Implementation Status & Handoff Guide

## üìã Current Implementation Status

### ‚úÖ Completed Features

#### 1. Basic x402 Protocol Flow
- **HTTP 402 Payment Required** response generation
- **X-PAYMENT header** processing for payment submission
- **X-PAYMENT-RESPONSE header** for payment confirmation
- **Two-phase payment flow**: Initial request ‚Üí 402 response ‚Üí Payment submission ‚Üí Success

#### 2. Device-Specific Pricing
- **Fixed pricing logic** with device-specific amounts:
  - `ESP32_001`: $0.01 USDC
  - `ESP32_002`: $0.005 USDC
- **Peak hour multiplier** (6PM-10PM: 1.5x price)
- **Dynamic pricing calculation** in `X402Service.calculateDevicePrice()`

#### 3. Frontend x402 Client
- **X402Client class** for handling payment flows
- **402 response parsing** and payment info extraction
- **Payment header creation** and submission
- **Error handling** for various response scenarios

#### 4. Backend x402 Service
- **Payment header validation** and parsing
- **Payment response generation**
- **Basic payment verification** (field presence check)
- **Integration with device command execution**

#### 5. Payment Modal Integration
- **Direct USDC payment** processing via Coinbase Wallet
- **x402 flow integration** with payment modal
- **Transaction confirmation** and balance updates
- **Enhanced debugging logs** for payment tracking

### üö® Critical Missing Implementations

#### 1. **Blockchain Transaction Verification** (HIGHEST PRIORITY)
**Location**: `/home/runner/workspace/server/services/x402.ts:90-94`

```typescript
static async verifyPayment(payment: X402PaymentRequest): Promise<boolean> {
  // ‚ùå CURRENT: Basic field validation only
  return !!(payment.amount && payment.currency && payment.network && payment.metadata?.txHash);
  
  // ‚úÖ NEEDS: Actual blockchain verification
  // TODO: Implement Web3 transaction verification
  // 1. Connect to Base Sepolia RPC
  // 2. Verify transaction hash exists
  // 3. Check transaction amount matches
  // 4. Verify recipient address
  // 5. Confirm transaction success
}
```

**Implementation Requirements**:
- Install `ethers` or `web3.js`
- Add Base Sepolia RPC endpoint
- Implement transaction receipt verification
- Validate USDC transfer amount and recipient

#### 2. **Payment Recipient Address Fix**
**Location**: `/home/runner/workspace/client/src/lib/x402-client.ts:157`

```typescript
// ‚ùå CURRENT: Wrong recipient (sender's wallet)
recipient: paymentData.walletAddress,

// ‚úÖ SHOULD BE: Actual payment recipient
recipient: '0x1c7d4b196cb0c7b01d743fbc6116a902379c7238', // or from payment info
```

#### 3. **Double-Spending Prevention**
- **Payment tracking database** to prevent duplicate payments
- **Nonce/unique ID system** for each payment request
- **Timestamp validation** to prevent replay attacks

#### 4. **Enhanced Error Handling**
- **Gas estimation failures**
- **Network connectivity issues**
- **Transaction timeout handling**
- **Insufficient balance scenarios**

## üèóÔ∏è Architecture Overview

### Payment Flow Sequence
```
1. User clicks device action
2. Frontend: POST /api/devices/{id}/commands/{command} (no X-PAYMENT header)
3. Backend: Returns 402 with payment requirements
4. Frontend: Shows PaymentModal with pricing
5. User: Confirms payment via Coinbase Wallet
6. Frontend: Sends USDC transaction on blockchain
7. Frontend: POST /api/devices/{id}/commands/{command} (with X-PAYMENT header)
8. Backend: Verifies payment and executes command
9. Backend: Returns success with X-PAYMENT-RESPONSE header
10. Frontend: Updates balance and shows success
```

### Key Files

#### Backend
- `server/services/x402.ts` - Core x402 service and verification
- `server/routes.ts:41-117` - Device command endpoint with x402 flow
- `server/services/payment.ts` - Payment processing and database storage
- `server/services/websocket.ts` - Device communication

#### Frontend  
- `client/src/lib/x402-client.ts` - x402 protocol client
- `client/src/components/payment-modal.tsx` - Payment UI and flow
- `client/src/lib/coinbase-wallet.ts` - Blockchain payment execution
- `client/src/pages/dashboard.tsx` - Device interaction UI

## üõ†Ô∏è Development Environment

### Prerequisites
- Node.js 20+
- Base Sepolia testnet access
- USDC on Base Sepolia for testing
- Coinbase Wallet with Base Sepolia network

### Environment Variables
```bash
# Backend (.env)
PORT=5001
PAYMENT_RECIPIENT=0x1c7d4b196cb0c7b01d743fbc6116a902379c7238
DATABASE_URL=sqlite:./database.db

# Frontend (.env)
VITE_BACKEND_PORT=5001
VITE_USDC_CONTRACT_ADDRESS=0x036CbD53842c5426634e7929541eC2318f3dCF7e
```

### Running the Application
```bash
# Terminal 1: Backend
PORT=5001 npm run dev

# Terminal 2: Frontend  
VITE_BACKEND_PORT=5001 npx vite --port 3000
```

## üöß Immediate Next Steps (Priority Order)

### 1. Implement Blockchain Verification (Critical)
```typescript
// Add to server/services/x402.ts
import { ethers } from 'ethers';

const provider = new ethers.JsonRpcProvider('https://sepolia.base.org');
const USDC_ADDRESS = '0x036CbD53842c5426634e7929541eC2318f3dCF7e';

static async verifyPayment(payment: X402PaymentRequest): Promise<boolean> {
  try {
    const txHash = payment.metadata?.txHash;
    if (!txHash) return false;
    
    // Get transaction receipt
    const receipt = await provider.getTransactionReceipt(txHash);
    if (!receipt || receipt.status !== 1) return false;
    
    // Verify USDC transfer amount and recipient
    // Parse transfer logs and validate
    
    return true;
  } catch (error) {
    console.error('Payment verification failed:', error);
    return false;
  }
}
```

### 2. Fix Payment Recipient Address
- Update `X402Client.submitPayment()` to use correct recipient
- Ensure consistency between 402 response and payment submission

### 3. Add Payment Deduplication
```typescript
// Add payment tracking to prevent double-spending
static async verifyPayment(payment: X402PaymentRequest): Promise<boolean> {
  // Check if transaction hash already processed
  const existingPayment = await storage.getPaymentByTxHash(payment.metadata.txHash);
  if (existingPayment) {
    console.warn('Payment already processed:', payment.metadata.txHash);
    return false;
  }
  
  // Continue with blockchain verification...
}
```

### 4. Enhanced Error Handling
- Add specific error messages for common failure scenarios
- Implement retry logic for network timeouts
- Add gas estimation with buffer for reliable transactions

## üìä Testing Strategy

### Unit Tests Needed
- `X402Service.verifyPayment()` with mock blockchain responses
- `X402Client` payment flow simulation
- Payment modal user interaction flows

### Integration Tests
- End-to-end payment flow with testnet
- Device command execution after payment
- Error scenarios (insufficient balance, network failures)

### Manual Testing Checklist
- [ ] ESP32_001 payment ($0.01 USDC)
- [ ] ESP32_002 payment ($0.005 USDC) 
- [ ] Peak hour pricing (1.5x multiplier)
- [ ] Balance updates after payment
- [ ] Transaction history recording
- [ ] Error handling for failed payments
- [ ] Double-payment prevention

## üîí Security Considerations

### Current Vulnerabilities
1. **No blockchain verification** - payments not actually validated
2. **Replay attack possibility** - no nonce/timestamp validation
3. **Amount manipulation** - no server-side amount verification
4. **Recipient spoofing** - incorrect recipient in payment header

### Recommended Security Enhancements
1. **Server-side amount calculation** - never trust client pricing
2. **Timestamp validation** - reject old payment requests
3. **Rate limiting** - prevent spam payment attempts
4. **Payment expiry** - time-bound payment requests
5. **Audit logging** - comprehensive payment attempt logging

## üìà Future Enhancements

### Protocol Extensions
- **Multi-asset payments** (ETH, other ERC-20 tokens)
- **Batch payments** for multiple device actions
- **Subscription payments** for ongoing access
- **Dynamic pricing** based on device load/availability

### User Experience
- **Payment preauthorization** to avoid repeated confirmations
- **Balance caching** for faster UI updates
- **Payment history export**
- **Spending analytics and insights**

### Integration Opportunities
- **Other wallet providers** (MetaMask, WalletConnect)
- **Layer 2 solutions** for lower transaction costs
- **Cross-chain payments** via bridges
- **Fiat on-ramps** for easier USDC acquisition

---

## üìû Contact & Handoff Notes

**Current Status**: x402 protocol foundation complete, blockchain verification pending
**Estimated Completion**: 2-3 days for full implementation
**Risk Level**: Medium (functional for testing, needs security hardening for production)

**Key Decision Points**:
1. Choose Web3 library (ethers.js recommended)
2. Determine payment verification timeout (suggest 30 seconds)
3. Define error retry strategy and limits
4. Plan database schema for payment deduplication

This implementation provides a solid foundation for x402-based IoT payments but requires the critical blockchain verification component before production deployment.
## üéØ Recent Fixes & Improvements Completed

### Balance Precision Fix
- **Issue**: 0.0005 USDC changes weren't reflected in UI despite blockchain confirmation
- **Fix**: Changed `getUSDCBalance()` from `toFixed(2)` to `toFixed(4)` precision
- **Files**: `client/src/lib/coinbase-wallet.ts:142, 218`
- **Result**: UI now properly displays small balance changes

### Device Pricing Correction
- **Issue**: ESP32_002 showed $0.010 instead of $0.005
- **Fix**: Updated X402Service with device-specific pricing map
- **Files**: `server/services/x402.ts:21-24`
- **Result**: Correct pricing displayed in UI and API responses

### Transaction History Fix
- **Issue**: Recent Transactions not displaying payment history
- **Fix**: Changed from non-existent `/api/users` to `/api/payments` endpoint
- **Files**: `client/src/pages/dashboard.tsx:34-55`
- **Result**: Payment history properly loads with 404 graceful handling

### UI Improvements
- **Payment Status Component**: Removed static component (was showing only "No active payments")
- **Connect Wallet Button**: Centered text alignment for better UX
- **Balance Display**: Updated to show 4 decimal places (0.0000 format)

## üî• Critical Implementation Issues Still Remaining

### 1. **Payment Recipient Address Mismatch**
**Current Issue**: Payment header incorrectly uses sender's wallet address as recipient

```typescript
// ‚ùå INCORRECT - client/src/lib/x402-client.ts:157
recipient: paymentData.walletAddress, // This is the sender, not recipient!

// ‚úÖ SHOULD BE:
recipient: paymentRecipient, // From 402 response or environment variable
```

### 2. **No Actual Blockchain Verification**
**Current Issue**: Server only checks if txHash field exists, doesn't verify on-chain

```typescript
// ‚ùå CURRENT - server/services/x402.ts:90-94  
static async verifyPayment(payment: X402PaymentRequest): Promise<boolean> {
  // Only checks if fields exist, no blockchain verification
  return !!(payment.amount && payment.currency && payment.network && payment.metadata?.txHash);
}
```

### 3. **Security Vulnerabilities**
- No double-spending protection
- No transaction amount verification
- No replay attack prevention  
- No payment expiry validation

## üìã Working Implementation Status

### ‚úÖ What's Currently Working

```mermaid
sequenceDiagram
    participant User
    participant UI
    participant PaymentModal
    participant WalletService
    participant X402Client
    participant Server

    User->>UI: "Play Gacha" „ÇØ„É™„ÉÉ„ÇØ
    UI->>PaymentModal: Áõ¥Êé•„É¢„Éº„ÉÄ„É´Ë°®Á§∫
    Note over UI,PaymentModal: 402„É™„ÇØ„Ç®„Çπ„Éà„Çí„Çπ„Ç≠„ÉÉ„Éó
    User->>PaymentModal: "Pay Now" „ÇØ„É™„ÉÉ„ÇØ
    PaymentModal->>WalletService: sendUSDCPayment()
    WalletService->>PaymentModal: txHash
    PaymentModal->>X402Client: submitPayment()
    X402Client->>Server: POST with X-PAYMENT header
    Server->>X402Client: 200 OK
    X402Client->>PaymentModal: success
```

### ÂïèÈ°åÁÇπ

1. **Ê®ôÊ∫ñÈùûÊ∫ñÊã†**: ÊúÄÂàù„ÅÆ402„É¨„Çπ„Éù„É≥„ÇπÂèñÂæó„Åå„Å™„ÅÑ
2. **‰æ°Ê†ºÁô∫Ë¶ã„ÅÆÊ¨†Â¶Ç**: „Çµ„Éº„Éê„Éº„Åã„ÇâÂãïÁöÑ„Å™‰æ°Ê†ºÊÉÖÂ†±„ÇíÂèñÂæó„Åó„Å¶„ÅÑ„Å™„ÅÑ
3. **„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞‰∏çË∂≥**: ÊîØÊâï„ÅÑË¶ÅÊ±Ç„ÅÆÊ§úË®º„Éó„É≠„Çª„Çπ„Åå„Å™„ÅÑ
4. **ÊüîËªüÊÄß„ÅÆÊ¨†Â¶Ç**: „Éá„Éê„Ç§„ÇπÁä∂ÊÖã„Å´Âøú„Åò„ÅüÂãïÁöÑ‰æ°Ê†ºË®≠ÂÆö„Åå„Åß„Åç„Å™„ÅÑ

### ÁèæÂú®„ÅÆ„Ç≥„Éº„ÉâÊßãÈÄ†

```typescript
// dashboard.tsx - ÁèæÂú®„ÅÆÂÆüË£Ö
const handleDeviceCommand = (device: Device, command: string) => {
  if (!walletAddress) {
    alert('Please connect your wallet first');
    return;
  }
  
  // ÈùôÁöÑ‰æ°Ê†º„Çí‰ΩøÁî®
  const deviceMetadata = device.metadata as { price?: string } | null;
  const amount = deviceMetadata?.price || '10.00';
  
  // Áõ¥Êé•PaymentModal„ÇíË°®Á§∫Ôºà402„Éó„É≠„Çª„Çπ„Çí„Çπ„Ç≠„ÉÉ„ÉóÔºâ
  setPaymentModalData({ device, command, amount });
};
```

## ÂÆåÂÖ®„Å™x402„Éï„É≠„ÉºÔºàÂÆüË£ÖÂæåÔºâ

### HTTP 402 Payment Required „Éó„É≠„Éà„Ç≥„É´

HTTP 402„ÅØ„ÄåPayment Required„Äç„ÇíÁ§∫„Åô„Çπ„ÉÜ„Éº„Çø„Çπ„Ç≥„Éº„Éâ„Åß„ÄÅ„ÇØ„É©„Ç§„Ç¢„É≥„Éà„Åå„É™„ÇΩ„Éº„Çπ„Å´„Ç¢„ÇØ„Çª„Çπ„Åô„Çã„Åü„ÇÅ„Å´ÊîØÊâï„ÅÑ„ÅåÂøÖË¶Å„Åß„ÅÇ„Çã„Åì„Å®„ÇíÁ§∫„Åó„Åæ„Åô„ÄÇ

### ÂÆåÂÖ®„Éï„É≠„Éº„ÅÆÊ¶ÇË¶Å

```mermaid
sequenceDiagram
    participant User
    participant UI
    participant X402Client
    participant PaymentModal
    participant WalletService
    participant Server
    participant X402Service
    participant Blockchain

    User->>UI: "Play Gacha" „ÇØ„É™„ÉÉ„ÇØ
    
    Note over UI,Server: Phase 1: Payment Discovery
    UI->>X402Client: executeDeviceCommand(deviceId, "play")
    X402Client->>Server: POST /api/devices/ESP32_001/commands/play (no payment header)
    Server->>X402Service: create402Response()
    X402Service->>Server: 402 response with payment requirements
    Server->>X402Client: 402 Payment Required
    
    Note over X402Client,UI: Phase 2: Payment UI
    X402Client->>UI: return { success: false, error: "PAYMENT_REQUIRED", paymentInfo }
    UI->>PaymentModal: show modal with server-provided amount
    
    Note over PaymentModal,Blockchain: Phase 3: Payment Execution
    User->>PaymentModal: "Pay Now" „ÇØ„É™„ÉÉ„ÇØ
    PaymentModal->>WalletService: sendUSDCPayment(recipient, amount)
    WalletService->>Blockchain: USDC transfer
    Blockchain->>WalletService: txHash
    
    Note over PaymentModal,Server: Phase 4: Payment Verification
    PaymentModal->>X402Client: submitPayment(deviceId, "play", paymentData)
    X402Client->>Server: POST /api/devices/ESP32_001/commands/play (with X-PAYMENT header)
    Server->>X402Service: parsePaymentHeader() & verifyPayment()
    X402Service->>Server: validation result
    Server->>Server: execute device command
    Server->>X402Client: 200 OK with X-PAYMENT-RESPONSE
    X402Client->>PaymentModal: success with paymentResponse
    PaymentModal->>User: "Payment Successful" Ë°®Á§∫
```

### Âà©ÁÇπ

1. **Ê®ôÊ∫ñÊ∫ñÊã†**: HTTP 402„Éó„É≠„Éà„Ç≥„É´„Å´ÂÆåÂÖ®Ê∫ñÊã†
2. **ÂãïÁöÑ‰æ°Ê†ºË®≠ÂÆö**: „Çµ„Éº„Éê„ÉºÂÅ¥„Åß‰æ°Ê†º„ÇíÂãïÁöÑ„Å´Ê±∫ÂÆöÂèØËÉΩ
3. **ÊîØÊâï„ÅÑÊ§úË®º**: „Éà„É©„É≥„Ç∂„ÇØ„Ç∑„Éß„É≥„ÅÆÂÆåÂÖ®„Å™Ê§úË®º„Éó„É≠„Çª„Çπ
4. **„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞**: ÂêÑÊÆµÈöé„Åß„ÅÆÈÅ©Âàá„Å™„Ç®„É©„ÉºÂá¶ÁêÜ
5. **Êã°ÂºµÊÄß**: Êßò„ÄÖ„Å™ÊîØÊâï„ÅÑÊñπÊ≥ï„ÇÑÈÄöË≤®„Å∏„ÅÆÂØæÂøú„ÅåÂÆπÊòì

## ÂÆüË£Ö„Å´ÂøÖË¶Å„Å™Â§âÊõ¥

### 1. X402Client „ÅÆÊã°Âºµ

```typescript
// client/src/lib/x402-client.ts - ËøΩÂä†„ÅåÂøÖË¶Å„Å™ÈÉ®ÂàÜ

export class X402Client {
  // Êñ∞Ë¶èËøΩÂä†: ÂàùÊúü„É™„ÇØ„Ç®„Çπ„ÉàÔºà402„É¨„Çπ„Éù„É≥„ÇπÂèñÂæóÔºâ
  static async executeDeviceCommand(
    deviceId: string, 
    command: string, 
    walletAddress: string
  ): Promise<{
    success: boolean;
    paymentRequired?: boolean;
    paymentInfo?: {
      amount: string;
      currency: string;
      network: string;
      recipient: string;
    };
    payment?: PaymentResponse;
    error?: string;
  }> {
    try {
      // Phase 1: ÊîØÊâï„ÅÑ„Éò„ÉÉ„ÉÄ„Éº„Å™„Åó„Åß„É™„ÇØ„Ç®„Çπ„Éà
      const response = await apiRequest('POST', `/api/devices/${deviceId}/commands/${command}`, {
        walletAddress
      });

      // ÊîØÊâï„ÅÑ„Åå‰∏çË¶Å„Å™Â†¥ÂêàÔºàÊó¢„Å´ÊîØÊâï„ÅÑÊ∏à„Åø„Å™„Å©Ôºâ
      const paymentResponseHeader = response.headers.get('X-PAYMENT-RESPONSE');
      if (paymentResponseHeader) {
        const paymentResponse = JSON.parse(atob(paymentResponseHeader));
        return { success: true, payment: paymentResponse };
      }

      return { success: true };

    } catch (error: any) {
      // 402 Payment Required „ÅÆÂá¶ÁêÜ
      if (error.status === 402) {
        const paymentInfo = this.parse402Response(error.response);
        return {
          success: false,
          paymentRequired: true,
          paymentInfo
        };
      }
      
      return { success: false, error: error.message };
    }
  }

  // Êñ∞Ë¶èËøΩÂä†: 402„É¨„Çπ„Éù„É≥„Çπ„ÅÆËß£Êûê
  private static parse402Response(response: any): {
    amount: string;
    currency: string;
    network: string;
    recipient: string;
  } {
    const payment = response.body?.payment;
    if (payment?.accepts && payment.accepts.length > 0) {
      const acceptedPayment = payment.accepts[0];
      return {
        amount: acceptedPayment.amount,
        currency: 'USDC', // acceptedPayment.asset „Åã„ÇâÊé®Ê∏¨
        network: acceptedPayment.network,
        recipient: acceptedPayment.recipient
      };
    }
    
    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÂÄ§
    return {
      amount: '0.01',
      currency: 'USDC',
      network: 'eip155:84532',
      recipient: '0x1c7d4b196cb0c7b01d743fbc6116a902379c7238'
    };
  }

  // Êó¢Â≠ò„ÅÆsubmitPayment()„ÅØÂ§âÊõ¥„Å™„Åó
}
```

### 2. Dashboard „Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„ÅÆÂ§âÊõ¥

```typescript
// client/src/pages/dashboard.tsx - Â§âÊõ¥„ÅåÂøÖË¶Å„Å™ÈÉ®ÂàÜ

export default function Dashboard() {
  // Êñ∞Ë¶èËøΩÂä†: ÊîØÊâï„ÅÑÁä∂ÊÖãÁÆ°ÁêÜ
  const [paymentState, setPaymentState] = useState<'idle' | 'checking' | 'payment_required' | 'processing'>('idle');

  // Â§âÊõ¥: handleDeviceCommand „ÅÆÂÆåÂÖ®Êõ∏„ÅçÊèõ„Åà
  const handleDeviceCommand = async (device: Device, command: string) => {
    if (!walletAddress) {
      alert('Please connect your wallet first');
      return;
    }

    setPaymentState('checking');

    try {
      // Phase 1: x402„Éï„É≠„Éº„Åß„ÅÆÂàùÊúü„É™„ÇØ„Ç®„Çπ„Éà
      const result = await X402Client.executeDeviceCommand(device.id, command, walletAddress);

      if (result.success) {
        // ÊîØÊâï„ÅÑ‰∏çË¶ÅÔºàÊó¢„Å´ÊîØÊâï„ÅÑÊ∏à„Åø„Åæ„Åü„ÅØÁÑ°ÊñôÊìç‰ΩúÔºâ
        console.log('Command executed successfully:', result.payment);
        setPaymentState('idle');
        return;
      }

      if (result.paymentRequired && result.paymentInfo) {
        // Phase 2: ÊîØÊâï„ÅÑ„ÅåÂøÖË¶Å - PaymentModal„ÇíË°®Á§∫
        setPaymentModalData({
          device,
          command,
          amount: result.paymentInfo.amount,
          recipient: result.paymentInfo.recipient
        });
        setPaymentState('payment_required');
      } else {
        // „Ç®„É©„Éº„Ç±„Éº„Çπ
        console.error('Device command failed:', result.error);
        alert(result.error || 'Command failed');
        setPaymentState('idle');
      }
    } catch (error) {
      console.error('Device command error:', error);
      alert('Failed to execute command');
      setPaymentState('idle');
    }
  };

  // PaymentModalData „ÅÆÂûã„ÇÇÊõ¥Êñ∞„ÅåÂøÖË¶Å
  const [paymentModalData, setPaymentModalData] = useState<{
    device: Device;
    command: string;
    amount: string;
    recipient: string; // Êñ∞Ë¶èËøΩÂä†
  } | null>(null);
};
```

### 3. PaymentModal „Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„ÅÆÂ§âÊõ¥

```typescript
// client/src/components/payment-modal.tsx - Â§âÊõ¥„ÅåÂøÖË¶Å„Å™ÈÉ®ÂàÜ

interface PaymentModalProps {
  device: Device;
  command: string;
  amount: string;
  recipient: string; // Êñ∞Ë¶èËøΩÂä†: „Çµ„Éº„Éê„Éº„Åã„ÇâÂèñÂæó„Åó„Åürecipient
  walletAddress: string;
  onClose: () => void;
}

export default function PaymentModal({ 
  device, 
  command, 
  amount, 
  recipient, // „Çµ„Éº„Éê„Éº„Åã„ÇâÂèó„ÅëÂèñ„Å£„ÅüÂÄ§„Çí‰ΩøÁî®
  walletAddress, 
  onClose 
}: PaymentModalProps) {
  
  const paymentMutation = useMutation({
    mutationFn: async () => {
      setPaymentStatus('processing');
      setPaymentError(null);

      try {
        // recipient „ÅØ props „Åã„Çâ‰ΩøÁî®ÔºàÁí∞Â¢ÉÂ§âÊï∞„Åß„ÅØ„Å™„ÅèÔºâ
        console.log(`üí∞ Starting USDC payment:`, {
          recipient, // „Çµ„Éº„Éê„ÉºÊåáÂÆö„ÅÆÈÄÅÈáëÂÖà
          amount,
          walletAddress,
          device: device.name
        });
        
        // Phase 3: USDCÊîØÊâï„ÅÑÂÆüË°å
        setPaymentStatus('confirming');
        const txHash = await walletService.sendUSDCPayment(recipient, amount);
        
        console.log(`‚úÖ Payment transaction submitted:`, txHash);
        
        // Phase 4: x402ÁµåÁî±„ÅßÊîØÊâï„ÅÑÊ§úË®º
        const result = await X402Client.submitPayment(device.id, command, {
          amount,
          currency: 'USDC',
          network: 'eip155:84532',
          txHash,
          walletAddress
        });

        if (!result.success) {
          throw new Error(result.error || 'Payment verification failed');
        }

        setPaymentStatus('completed');
        // ... ‰ª•‰∏ã„ÅØÊó¢Â≠ò„Å®Âêå„Åò
      } catch (error: any) {
        setPaymentStatus('error');
        setPaymentError(error.message);
        throw error;
      }
    }
  });
};
```

### 4. „Çµ„Éº„Éê„Éº„Çµ„Ç§„Éâ„ÅÆÂ§âÊõ¥

```typescript
// server/services/x402.ts - ËøΩÂä†„ÅåÂøÖË¶Å„Å™ÈÉ®ÂàÜ

export class X402Service {
  // Êñ∞Ë¶èËøΩÂä†: ÂãïÁöÑ‰æ°Ê†ºË®àÁÆó
  static calculateDevicePrice(deviceId: string, command: string): string {
    // „Éá„Éê„Ç§„Çπ„Çø„Ç§„Éó„ÇÑÊôÇÈñìÂ∏Ø„Å´Âü∫„Å•„ÅèÂãïÁöÑ‰æ°Ê†ºË®≠ÂÆö
    const basePrice = {
      'gacha': '0.01',
      'lock': '0.005',
      'light': '0.001'
    };
    
    // ÊôÇÈñìÂ∏Ø„ÇÑÈúÄË¶Å„Å´Âøú„Åò„Åü‰æ°Ê†ºË™øÊï¥„É≠„Ç∏„ÉÉ„ÇØ
    // ‰æã: „Éî„Éº„ÇØÊôÇÈñì„ÅØ‰æ°Ê†º‰∏äÊòá
    const hour = new Date().getHours();
    const peakHourMultiplier = (hour >= 18 && hour <= 22) ? 1.5 : 1.0;
    
    const device = getDeviceById(deviceId);
    const deviceType = device?.type || 'gacha';
    const price = parseFloat(basePrice[deviceType] || '0.01') * peakHourMultiplier;
    
    return price.toFixed(3);
  }

  // Â§âÊõ¥: create402Response „Å´ÂãïÁöÑ‰æ°Ê†ºË®≠ÂÆö„ÇíËøΩÂä†
  static create402Response(deviceId: string, command: string): any {
    const amount = this.calculateDevicePrice(deviceId, command);
    const recipient = process.env.PAYMENT_RECIPIENT || '0x1c7d4b196cb0c7b01d743fbc6116a902379c7238';
    
    return {
      status: 402,
      headers: {
        'Content-Type': 'application/json',
        'WWW-Authenticate': 'Payment'
      },
      body: {
        message: 'Payment Required',
        payment: {
          accepts: [{
            scheme: 'exact',
            network: 'eip155:84532', // Base Sepolia
            asset: '0x036CbD53842c5426634e7929541eC2318f3dCF7e', // USDC
            amount: amount,
            recipient: recipient
          }],
          metadata: {
            deviceId,
            command,
            timestamp: new Date().toISOString()
          }
        }
      }
    };
  }
}
```

### 5. „É´„Éº„Éà„Éè„É≥„Éâ„É©„Éº„ÅÆÂ§âÊõ¥

```typescript
// server/routes.ts - Â§âÊõ¥„ÅåÂøÖË¶Å„Å™ÈÉ®ÂàÜ

// „Éá„Éê„Ç§„Çπ„Ç≥„Éû„É≥„ÉâÂÆüË°å„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà
router.post('/api/devices/:id/commands/:command', async (req, res) => {
  try {
    const { id: deviceId, command } = req.params;
    const { walletAddress } = req.body;
    const paymentHeader = req.headers['x-payment'] as string;

    // Phase 1: ÊîØÊâï„ÅÑ„Éò„ÉÉ„ÉÄ„Éº„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ402„ÇíËøî„Åô
    if (!paymentHeader) {
      const response = X402Service.create402Response(deviceId, command);
      return res.status(402).json(response.body);
    }

    // Phase 2: ÊîØÊâï„ÅÑ„Éò„ÉÉ„ÉÄ„Éº„ÅÆÊ§úË®º
    const payment = X402Service.parsePaymentHeader(paymentHeader);
    if (!payment) {
      return res.status(400).json({ message: 'Invalid payment header' });
    }

    // Phase 3: ÊîØÊâï„ÅÑ„ÅÆÊ§úË®º
    const isValid = await X402Service.verifyPayment(payment);
    if (!isValid) {
      return res.status(402).json({ message: 'Payment verification failed' });
    }

    // Phase 4: „Éá„Éê„Ç§„Çπ„Ç≥„Éû„É≥„Éâ„ÅÆÂÆüË°å
    const device = await executeDeviceCommand(deviceId, command);
    
    // Phase 5: ÊîØÊâï„ÅÑ„É¨„Çπ„Éù„É≥„Çπ„Éò„ÉÉ„ÉÄ„Éº„ÅÆÁîüÊàê
    const paymentResponse = X402Service.createPaymentResponse(payment, generatePaymentId());
    const responseHeader = Buffer.from(JSON.stringify(paymentResponse)).toString('base64');
    
    res.setHeader('X-PAYMENT-RESPONSE', responseHeader);
    res.json({
      success: true,
      device,
      payment: paymentResponse
    });

  } catch (error) {
    console.error('Device command error:', error);
    res.status(500).json({ message: 'Internal server error' });
  }
});
```

## „Ç∑„Éº„Ç±„É≥„ÇπÂõ≥„ÅÆÊØîËºÉ

### ÁèæÂú®„ÅÆÂÆüË£ÖÔºàÁ∞°Á¥†ÂåñÔºâ
```
User ‚Üí UI ‚Üí PaymentModal ‚Üí WalletService ‚Üí Blockchain ‚Üí Server
     (Áõ¥Êé•)    (Static Price)     (USDC Transfer)      (Payment Verify)
```

### ÂÆåÂÖ®x402ÂÆüË£ÖÔºàÊ®ôÊ∫ñÊ∫ñÊã†Ôºâ
```
User ‚Üí UI ‚Üí X402Client ‚Üí Server ‚Üí X402Client ‚Üí UI ‚Üí PaymentModal ‚Üí WalletService ‚Üí Blockchain
     (Click)  (No Payment)  (402)   (Payment Info)  (Modal) (Dynamic Price) (USDC Transfer)
                                                                                    ‚Üì
Server ‚Üê X402Client ‚Üê PaymentModal ‚Üê WalletService ‚Üê Blockchain
(Verify)  (With Payment Header)        (Success)         (txHash)
```

## ÂÆüË£ÖÊâãÈ†Ü

### Step 1: X402Client „ÅÆÊã°Âºµ
1. `executeDeviceCommand` „É°„ÇΩ„ÉÉ„Éâ„ÇíËøΩÂä†
2. `parse402Response` „É°„ÇΩ„ÉÉ„Éâ„ÇíËøΩÂä†  
3. „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞„ÅÆÊîπÂñÑ

### Step 2: Dashboard „ÅÆÂ§âÊõ¥
1. `handleDeviceCommand` „ÇíÈùûÂêåÊúüÂá¶ÁêÜ„Å´Â§âÊõ¥
2. ÊîØÊâï„ÅÑÁä∂ÊÖãÁÆ°ÁêÜ„ÇíËøΩÂä†
3. PaymentModalDataÂûã„ÇíÊõ¥Êñ∞

### Step 3: PaymentModal „ÅÆÊõ¥Êñ∞
1. Props „Å´ `recipient` „ÇíËøΩÂä†
2. „Çµ„Éº„Éê„ÉºÊåáÂÆö„ÅÆÈÄÅÈáëÂÖà„Çí‰ΩøÁî®
3. ÂãïÁöÑ‰æ°Ê†ºË°®Á§∫„ÅÆÂØæÂøú

### Step 4: „Çµ„Éº„Éê„Éº„Çµ„Ç§„Éâ„ÅÆÊã°Âºµ
1. `calculateDevicePrice` „É°„ÇΩ„ÉÉ„Éâ„ÇíËøΩÂä†
2. `create402Response` „ÇíÂãïÁöÑ‰æ°Ê†ºÂØæÂøú„Å´Â§âÊõ¥
3. „É´„Éº„Éà„Éè„É≥„Éâ„É©„Éº„Åß402„Éï„É≠„Éº„ÇíÂÆüË£Ö

### Step 5: „ÉÜ„Çπ„Éà„Å®„Éá„Éê„ÉÉ„Ç∞
1. ÂêÑ„Éï„Çß„Éº„Ç∫„ÅÆ„É≠„Ç∞Âá∫Âäõ„ÇíËøΩÂä†
2. „Ç®„É©„Éº„Ç±„Éº„Çπ„ÅÆ„ÉÜ„Çπ„Éà
3. „Éà„É©„É≥„Ç∂„ÇØ„Ç∑„Éß„É≥Ê§úË®º„ÅÆÁ¢∫Ë™ç

## „ÉÜ„Çπ„ÉàÊñπÊ≥ï

### 1. Phase 1 „ÉÜ„Çπ„Éà (Payment Discovery)
```bash
curl -X POST http://localhost:5000/api/devices/ESP32_001/commands/play \
  -H "Content-Type: application/json" \
  -d '{"walletAddress":"0x1234..."}'

# ÊúüÂæÖ: 402 Payment Required „É¨„Çπ„Éù„É≥„Çπ
```

### 2. Phase 2 „ÉÜ„Çπ„Éà (Payment Modal)
- UI „Åß„Éá„Éê„Ç§„Çπ„Çí„ÇØ„É™„ÉÉ„ÇØ
- PaymentModal „Åå402„É¨„Çπ„Éù„É≥„Çπ„ÅÆ‰æ°Ê†º„ÅßË°®Á§∫„Åï„Çå„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç

### 3. Phase 3 „ÉÜ„Çπ„Éà (Payment Execution)
- "Pay Now" „Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ
- Coinbase Wallet „Åß„Éà„É©„É≥„Ç∂„ÇØ„Ç∑„Éß„É≥Á¢∫Ë™ç
- txHash „ÅåÂèñÂæó„Åï„Çå„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç

### 4. Phase 4 „ÉÜ„Çπ„Éà (Payment Verification)
```bash
curl -X POST http://localhost:5000/api/devices/ESP32_001/commands/play \
  -H "Content-Type: application/json" \
  -H "X-PAYMENT: <base64-encoded-payment-data>" \
  -d '{"walletAddress":"0x1234..."}'

# ÊúüÂæÖ: 200 OK with X-PAYMENT-RESPONSE header
```

### 5. End-to-End „ÉÜ„Çπ„Éà
1. „Ç¶„Ç©„É¨„ÉÉ„ÉàÊé•Á∂ö
2. „Éá„Éê„Ç§„Çπ„ÇØ„É™„ÉÉ„ÇØ
3. ÊîØÊâï„ÅÑÂÆüË°å
4. ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏Á¢∫Ë™ç
5. „Éà„É©„É≥„Ç∂„ÇØ„Ç∑„Éß„É≥Â±•Ê≠¥Á¢∫Ë™ç

## „Åæ„Å®„ÇÅ

ÂÆåÂÖ®„Å™x402ÂÆüË£Ö„Å´„Çà„Çä‰ª•‰∏ã„ÅåÂÆüÁèæ„Åï„Çå„Åæ„ÅôÔºö

- ‚úÖ HTTP 402„Éó„É≠„Éà„Ç≥„É´Ê®ôÊ∫ñÊ∫ñÊã†
- ‚úÖ ÂãïÁöÑ‰æ°Ê†ºË®≠ÂÆöÊ©üËÉΩ
- ‚úÖ ÂåÖÊã¨ÁöÑÊîØÊâï„ÅÑÊ§úË®º
- ‚úÖ ÊîπÂñÑ„Åï„Çå„Åü„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
- ‚úÖ Êã°ÂºµÂèØËÉΩ„Å™„Ç¢„Éº„Ç≠„ÉÜ„ÇØ„ÉÅ„É£

„Åì„ÅÆÂÆüË£Ö„Å´„Çà„Çä„ÄÅxCockpit„ÅØ„Çà„ÇäÂ†ÖÁâ¢„ÅßÊ®ôÊ∫ñÊ∫ñÊã†„ÅÆWeb3 IoTÊ±∫Ê∏à„Ç≤„Éº„Éà„Ç¶„Çß„Ç§„Å´„Å™„Çä„Åæ„Åô„ÄÇ